---
title: CTFshow 红包题第二弹 php的临时上传文件绕过
swiper_index: 1
categories:
    -网络安全
tags:
  - php
  - ctfshow
abbrlink: 1
date: 2022-12-4 14:53:00
description: 酱紫？
updated: 2022-12-4 14:53:00
---
{% p h2, CTFshow 红包题第二弹 %}
# php的临时上传文件绕过
首页查看源码
![code](https://source.bugcarrot.top/articles/cfsweb/hongbaoti2/1.png)

得知大部分字符和特殊符号都被过滤了，构造CMD  通过可用的字符构造  cmd=?><?=\`.+/??p/p?p??????`  又eval  （$cmd）来执行临时文件

**用到的知识点**

1. 等于
{% tip %}
在php中，<??>为短标签，<?php ?>为长标签，修改php.ini配置文件 short_open_tag=On 才能使用短标签。 在php 5.4.0后，<?=  总是可以代替 <? Echo
{% endtip %}
![code](https://source.bugcarrot.top/articles/cfsweb/hongbaoti2/2.png)


2. 反引号 `
{% tip info %}
php中反引号的作用是命令执行，并返回命令的执行结果，引号中必须包括能执行的命令，否则会出错
{% endtip %}
![code](https://source.bugcarrot.top/articles/cfsweb/hongbaoti2/3.png)

3. 点.
{% tip bolt %}
点等于source，用来执行文件
Source /home/user/bash  ===  ./home/user/bash
{% endtip %}

4. 加号 +
{% tip cogs %}
URL编码中空格为%20，+表示为%2B，而url中+也可以表示空格，要表示+号必须得用%2B
{% endtip %}

5. /??p/p?p??????
{% tip bell %}
+ 临时文件夹目录：
    - php上传文件后会将文件存储在临时文件夹，然后用move_uoloaded_file()函数将上传的文件移动到新位置，临时文件夹可以通过php.ini 的upload_tmp_dir指定，默认是/tmp
+ 临时文件命名规则：
    - 默认为php+4或者随机数字和大小写字母，在windows下有tmp后缀，lunux没有，比如windows下：phpxxxxxx.tmp ; linux下：phpXXXXXX
+ 通配符：
    - 问号?代表一个任意字符，通配符/??p/p?p??????匹配/tmp/phpxxxxxx
{% endtip %}

{% radio cyan, 执行上传临时文件 %}

php的上传接受multipart/form-data，然后会将它保存在临时文件中。php.ini中设置的**upload_tmp_dir**就是这个临时文件的保存目录。linux下默认为/tmp。也就是说，只要是php接收到上传的POST请求，就会保存一个临时文件，如何这个php脚本具有“上传功能”那么它将拷贝走，无论如何当脚本执行结束这个临时文件都会被删除。另外，这个php临时文件在linux系统下的命名规则永远是  **phpXXXXXX**

临时文件内容：
![code](https://source.bugcarrot.top/articles/cfsweb/hongbaoti2/4.png#pic_left)

1. 构造url
![code](https://source.bugcarrot.top/articles/cfsweb/hongbaoti2/5.png#pic_left)

2. 抓包改成POST，构造上传表单

![code](https://source.bugcarrot.top/articles/cfsweb/hongbaoti2/6.png#pic_left)
![code](https://source.bugcarrot.top/articles/cfsweb/hongbaoti2/7.png#pic_left)
但是我自己实验没成功，改用第二种方法

# 复制文件
根据上面的思路其实我们可以不去执行上传临时文件，尝试把flag.txt复制到网站的目录即可，但是这里有2个前提：首先是网站目录有写权限；其次是知道flag文件的名字。

Payload: 
	?cmd=?><?=`/???/?p /???????? p.ppp`;?>
	
相当于
    ?cmd=?><?=`/bin/cp /flag.txt p.ppp`;?>
![code](https://source.bugcarrot.top/articles/cfsweb/hongbaoti2/8.png#pic_left)
![code](https://source.bugcarrot.top/articles/cfsweb/hongbaoti2/9.png#pic_left)
![code](https://source.bugcarrot.top/articles/cfsweb/hongbaoti2/10.png#pic_left)



